{% extends "supportwcl/generic_submit.des" %}
{% block content %}

{% if args.inputcals_file %}
<<include {{args.inputcals_file}}>>
{% else %}
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/inputcals/inputs.des>>
{% endif %}
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/modnamepat.wcl>>

<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/band-assemble.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/band-coadd-catalog.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/band-create-psfex-catalog.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/band-psfex.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/band-swarp-msk.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/band-swarp-wgt.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/catalog-ingest.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/coadd-astrorefine.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/combine-se-cat.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/det-assemble.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/det-catalog.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/det-create-psfex-catalog.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/det-psfex.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/det-swarp-msk.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/det-swarp-wgt.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/extinction.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/healpix.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/ingest-scamp-xml-exp.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/make-color-img.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/make-ptif.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/mangle.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/null-weight-for-coadd.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/split-scamp-head.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/bigquery.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/run-desmeds.wcl>>
<<include {{args.pipebox_dir}}/templates/pipelines/multiepoch/{{args.campaign}}/modulewcl/wavg.wcl>>
master_use_fwthreads = True

# these 2 are for debugging purposes
purge_job_dir = never
compress_cleanup = False

basket = {{args.tile}} # FIX THIS
proctag = {{args.proctag}}
tilename = {{args.tile}}
unitname = ${tilename}
{% if args.rundir %}
ops_run_dir = {{ args.rundir }}
{% else %}
ops_run_dir = ${project}/${pipeline}/${campaign}/${basket}-r${reqnum}/${unitname}/p${attnum:2}
{% endif %}
nthreads = {{ args.nthreads }}

save_run_vals = tilename, jira_id

<<inclfunc mepipelineappintg.mepochmisc.get_tile_info(submit_des_services, submit_des_db_section, tilename)>>

######################################################################
blocklist = me

<directory_pattern>
    <mepoch>
        name = mepoch
        ops = ${ops_run_dir}/${ops_enddir}
        runtime = ${rundir}
    </mepoch>
</directory_pattern>

<block>
    <me>
        modulelist = combine-se-cat, coadd-astrorefine, split-scamp-head, bigquery, null-weight-for-coadd, band-swarp-wgt, band-swarp-msk, det-swarp-wgt, det-swarp-msk, band-assemble, det-assemble, band-create-psfex-catalog, det-create-psfex-catalog, band-psfex, det-psfex, band-coadd-catalog, det-catalog, extinction, healpix, catalog-ingest, mangle, make-color-img, make-ptif, wavg, run-desmeds
    </me>
</block>

<filetype_metadata>
    <coadd_meds>
        <hdus>
            <primary>
                <r>
                    <w>
                        filename = filename
                        filetype = filetype
                        pfw_attempt_id = pfw_attempt_id
                    </w>
                </r>
            </primary>
        </hdus>
        metadata_table = desfile
        filetype_mgmt = filemgmt.ftmgmt_genfits.FtMgmtGenFits
    </coadd_meds>
    <coadd_meds_yaml>
        <hdus>
            <primary>
                <r>
                    <w>
                        filename = filename
                        filetype = filetype
                        pfw_attempt_id = pfw_attempt_id
                    </w>
                </r>
            </primary>
        </hdus>
        metadata_table = desfile
        filetype_mgmt = filemgmt.ftmgmt_generic.FtMgmtGeneric
    </coadd_meds_yaml>
    <coadd_wavg>
        <hdus>
            <primary>
                <r>
                    <w>
                        filename = filename
                        filetype = filetype
                        tilename = tilename
                        pfw_attempt_id = pfw_attempt_id
                    </w>
                </r>
            </primary>
#            <objects>
#                <o>
#                    <c>
#                        objects = objects
#                    </c>
#                </o>
#            </objects>
        </hdus>
        metadata_table = catalog
        filetype_mgmt = filemgmt.ftmgmt_genfits.FtMgmtGenFits
    </coadd_wavg>
    <coadd_wavg_oclink>
        <hdus>
            <primary>
                <r>
                    <w>
                        filename = filename
                        filetype = filetype
                        tilename = tilename
                        pfw_attempt_id = pfw_attempt_id
                    </w>
                </r>
            </primary>
#            <objects>
#                <o>
#                    <c>
#                        objects = objects
#                    </c>
#                </o>
#            </objects>
        </hdus>
        metadata_table = catalog
        filetype_mgmt = filemgmt.ftmgmt_genfits.FtMgmtGenFits
    </coadd_wavg_oclink>
</filetype_metadata>

{% endblock %}
