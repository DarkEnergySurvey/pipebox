# {{ args.submittime }}
{% if args.configfile %}
<<include {{ args.pipebox_work }}/config/{{ args.configfile }}>>
{% else %}
<<include {{ args.pipebox_work }}/config/{{ args.user }}_cfg.des>> {% endif %}

<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/modnamepat.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/01-crosstalk-sci.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/02-pixcorrect.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/03-null-weight-pixcor.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/04a-create-scamp-cat.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/04b-split-scamp-ahead.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/05a-run-scamp.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/05b-ingest-scamp-xml.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/05c-update-scamp-headers.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/06a-mkbleedmask.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/06b-ingest-bleedmask.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/06c-skycompress-mkbleedmask.wcl>>
{% if args.epoch_name in ['SVE1','SVE2'] %}
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/07-SV-skycombine-mkbleedmask.wcl>> 
{% else %}
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/07-skycombine-mkbleedmask.wcl>> 
{% endif %}
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/08a-skyfit.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/08b-ingest-skyfit.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/08c-skysub.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/08d-starflat.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/09a-null-weight-bkg.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/09b-create-bkg-img.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/10-immask.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/11-rowinterp-nullweight-immask.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/12a-create-psfex-cat.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/12b-run-psfex.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/12c-ingest-psfex-xml.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/13a-create-finalcut-catalog.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/13b-ingest-se-objects.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/14-finalcut-assess.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/modulewcl/15-mkpng.wcl>>

{% if args.epoch_name %}
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/inputcals/{{ args.epoch_name }}_{{ args.campaign }}_inputs.wcl>>
{% else %}
<<include {{ args.pipebox_dir }}/templates/pipelines/finalcut/{{ args.campaign }}/inputcals/{{ args.campaign }}_inputs.wcl>>
{% endif %}

# Database dependent definitions
submit_des_db_section = {{ args.db_section }}
target_des_db_section = {{ args.db_section }}

target_site = {{ args.target_site }}

{% if args.nginx %}
<archive>
    <{{args.archive_name}}>
        host = {{args.nginx_server}}.cosmology.illinois.edu
        root_http = http://{{args.nginx_server}}.cosmology.illinois.edu:8095/Prodbeta/archive
        input_transfer_semname_home  = nginx10-{{args.nginx_server}}-input
        output_transfer_semname_home = nginx10-{{args.nginx_server}}-output
    </{{args.archive_name}}>
</archive>
{% endif %}

{% if args.target_site in ['bluewaters-dev','bluewaters'] %}
<job_environment>
   HOME=/u/staff/{{ args.user }}
   USER={{ args.user }}
   EUPS_USERDATA=/tmp/.eups_{{ args.user }}
</job_environment>
{% endif %}

reqnum = {{ args.reqnum }}
jira_id = {{ args.jira_parent }}
{% if args.labels %}
label = {{ args.labels }} {% else %}
label = ${nite} {% endif %}

pipeprod = {{ args.eups_stack[0] }}
pipever = {{ args.eups_stack[1] }}
campaign = {{ args.campaign }}
project = {{ args.project }}

expnum = {{ args.expnum }}
band = {{ args.band }}
nite = {{ args.nite }}

{% if args.calnite %}
calnite = {{ args.calnite }} 
{% endif %}
{% if args.calrun %}
calrun = {{ args.calrun }} {% endif %}

{% if args.ccdnum %}
ccdnum = {{ args.ccdnum }} {% endif %}

{% if args.db_section == 'db-desoper' %}
se_object_table = PROD.SE_OBJECT
home_archive = desar2home
des_http_section = file-http {% endif %}

{% if args.db_section == 'db-destest' %}
se_object_table = PRODBETA.SE_OBJECT
{% if args.archive_name %}
home_archive = {{args.archive_name}} 
{% else %}
home_archive = prodbeta
{% endif %}
des_http_section = file-http-prodbeta 
{% endif %}

pipeline = finalcut    # used in desstat output

basket = ${campaign}
unitname = ${camera}${expnum:8}
ops_run_dir = ${project}/${pipeline}/${campaign}/${basket}-r${reqnum}/${unitname}/p${attnum:2}
submit_run_dir = /cluster_scratch/desdm_ops/${home_archive}/submit/${ops_run_dir}

save_run_vals = nite, camera, band, expnum, jira_id

GROUP_SUBMIT_ID = 1

blocklist = se

<block>
   <se>
#        modulelist = crosstalk-sci,pixcorrect,null-weight-pixcor,create-scamp-catalog,split-scamp-ahead,run-scamp,ingest-scamp-xml,update-scamp-headers,mkbleedmask,skycompress-mkbleedmask,skycombine-mkbleedmask,skyfit,ingest-skyfit,skysub,starflat,null-weight-bkg,create-bkg-img,immask,rowinterp-nullweight-immask,create-psfex-catalog,run-psfex,ingest-psfex-xml,create-finalcut-catalog,ingest-se-objects,finalcut-assess,mkpng
        modulelist = crosstalk-sci,pixcorrect,null-weight-pixcor,create-scamp-catalog,split-scamp-ahead,run-scamp,ingest-scamp-xml,update-scamp-headers,mkbleedmask,skycompress-mkbleedmask,skycombine-mkbleedmask,skyfit,ingest-skyfit,skysub,starflat,null-weight-bkg,create-bkg-img,immask,rowinterp-nullweight-immask,create-psfex-catalog,run-psfex,ingest-psfex-xml,create-finalcut-catalog,mkpng
    </se>    
</block>
