# {{ args.submittime }}
<<include {{ args.pipebox_work }}/{{ args.user }}_cfg.des>>

<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/modnamepat.wcl>>

<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/crosstalk-bias.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/mkbiascor.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/crosstalk-dflat.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/pixcorrect-dflat.wcl>>
{% if args.epoch_name in ['SVE1','SVE2'] %}
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/SV-skycombine-01.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/SV-skycombine-02.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/SV-skycombine-03.wcl>>
{% else %}
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/skycombine-01.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/skycombine-02.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/skycombine-03.wcl>>
{% endif %}
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/skycompare-pixcor.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/ingest-skycompare-pixcor.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/mkdflatcor.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/skycompress-01.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/find-flat-norm.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/scale-flat.wcl>>
<<include {{ args.pipebox_dir }}/templates/pipelines/nitelycal/{{ args.campaignlib }}/modulewcl/supercal_sv/skycompress-02.wcl>>

bias_expnum = {{ args.bias_list }}
dflat_expnum = {{ args.flat_list }}

target_site = {{ args.target_site }}

reqnum = {{ args.reqnum }}
jira_id = {{ args.jira_parent }}
{% if args.labels %}
label = {{ args.labels }}
{% else %}
label = {{ args.campaign }}_{{ args.nite }}
{% endif %}
pipeline = nitelycal
pipeprod = {{ args.eups_product }}
pipever = {{ args.eups_version }}
campaign = {{ args.campaign }}

nite = {{ args.nite }}
project = {{ args.project }}
ccdnum = {{ args.ccdnum }}

unitname = ${nite}
ops_run_dir = ${project}/${pipeline}/${nite}-r${reqnum}/p${attnum:2}
submit_run_dir = /cluster_scratch/desdm_ops/${home_archive}/submit/${ops_run_dir}

save_run_vals = nite, camera, jira_id

<filename_pattern>
    nite_band = ${camera}_n${nite}_${band}_r${reqnum}p${attnum:2}_${flabel}.${fsuffix}
</filename_pattern>

blocklist = xtalk-bias, mkbiascor, dflat-exp, skycombine-01,skycompare-pixcor,mkdflatcor,skycompress-01,skycombine-02,find-flat-norm,scale-flat,skycompress-02,skycombine-03

<block>
    <xtalk-bias>
        expnum = ${bias_expnum}
        divide_jobs_by = expnum
        modulelist = crosstalk-bias
    </xtalk-bias>
    <mkbiascor>
        divide_jobs_by = ccdnum
        modulelist = mkbiascor
        target_site = fermigrid-sl6-himem
    </mkbiascor>
    <pixcor-dflat>
        expnum = ${dflat_expnum}
        divide_jobs_by = expnum
        modulelist = pixcorrect-dflat
    </pixcor-dflat>
    <skycombine-01>
        expnum = ${dflat_expnum}
        divide_jobs_by = expnum
        modulelist = skycombine-01
    </skycombine-01>
    <skycompress-01>
        divide_jobs_by = ccdnum, band
        modulelist = skycompress-01
    </skycompress-01>
    <skycombine-02>
        divide_jobs_by = band
        modulelist = skycombine-02
    </skycombine-02>
    skycompress-02>
        divide_jobs_by = ccdnum, band
        modulelist = skycompress-02
    </skycompress-02>
    <skycombine-03>
        divide_jobs_by = band
        modulelist = skycombine-03
    </skycombine-03>
    <mkdflatcor>
        expnum = ${dflat_expnum}
        divide_jobs_by = ccdnum, band
        modulelist = mkdflatcor
        target_site = fermigrid-sl6-himem
    </mkdflatcor>
    <find-flat-norm>
        divide_jobs_by = band
        modulelist = find-flat-norm
    </find-flat-norm>
    <scale-flat>
        divide_jobs_by = ccdnum, band
        modulelist = scale-flat
    </scale-flat>
    <dflat-exp>
        expnum = ${dflat_expnum}
        divide_jobs_by = expnum
        modulelist = crosstalk-dflat, pixcorrect-dflat
    </dflat-exp>
    <skycompare-pixcor>
        expnum = ${dflat_expnum}
        divide_jobs_by = expnum,band
        modulelist = skycompare-pixcor,ingest-skycompare-pixcor
    </skycompare-pixcor>
    <ingest-skycompare-pixcor>
        expnum = ${dflat_expnum}
        modulelist = ingest-skycompare-pixcor
    </ingest-skycompare-pixcor>
</block>
